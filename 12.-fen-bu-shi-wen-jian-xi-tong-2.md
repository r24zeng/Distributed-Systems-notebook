# 12.分布式文件系统2

文件系统服务器会让你知道当前这个文件在哪个客户端读取了这个文件，如果某个客户端正在修改这个文件，你有权利决定看旧版还是最新版文件。

Adrew 文件系统用不同的方法在客户端缓存。大部分的文件都很小，因此缓存在一个客户端就够了，如果文件特别大，就需要序列化将文件分成一段段缓存在不同的客户端。临时读取的意思是，如果你读取文件的这段，那么未来你将会再次读取这段的可能性更大。

如何高效缓存需要高效的缓存算法，基本上这些算法都在围绕两点来设计：读取的频率和最近读取的文件段。算法的好坏取决于你能多聪明的利用这两点。

## 在Coda中分享文件

> Coda是一种与传统NFS不一样的分布式系统，主要特点是断网了依然可以工作，说明其客户端缓存做得好，主要区别是将文件分布在很多服务器上

客户端-服务器端架构：

* t：更新文件的间隔时间
* t\_c：文件最后的修改时间
* T：当前时间
* T\_m\(客户端或服务器端\)：服务器端最后记录的客户（服务器）的修改时间

\(T - T\_c\) &lt; t 说明当前时间与最后修改的时间小雨时间间隔，则这个文件依然可以继续使用。

T\_m client == T\_m server 说明文件最后的修改时间在客户端和服务器端是一样的，则两者持有的都是最新文件，那么这个文件依然可以继续使用。

文件分享机制实例：如果用户B修改完并且关闭了文件，将文件复制件发送回服务器，此时A正在读取文件，服务器就会告诉A复制无效，想要最新文件还是保留旧版本，A来做决定，如果A想要最新文件，只需关闭文件重新打开即可，这时服务器会响应新的"open"请求复制最新文件给A。如果用户B只是读取文件而不修改文件，这时候即便B关闭了文件，就不会发送文件复制给服务器，这样服务器也不会发消息给A了，因为大家手上都是最新版本的文件了。

## 基于集群的文件分布式系统（文件分布在不同的服务器上，例如谷歌的文件系统GFS）

两种类型：

* 文件分成若干段，同一个文件分布在同一个服务器集群上。有很高段容错率，即便其中一个服务器瘫痪了，其他服务器依然有权限进入到那个服务器上。
* 并行文件系统。文件分成若干段，同一个文件分布在不同到服务器上，为应对某个server突然瘫痪的情况，文件块成对分布在不同服务器上，这样即便一个服务死了，总有另一个服务器可以进入到那个文件块。

**管理员**（把文件名映射到持有那个文件块的服务器）：

* 只映射文件的元信息，和名字空间
* 将这些信息存储在内存中，定期更新，一旦死了，会使用上一次有效的映射
* GFS将文件分成每段64MB
* 这些段都分布式分布在不同的段服务器

**字段服务器**：每个段都复制在不同的段服务器上，为了防止一个字段服务器死掉的情况，会有冗余复制。管理员也叫名字服务器，不存储实际数据，只存储元数据信息，字段服务器就是具体那个字段存储的服务器，其中有一个首要字段服务器。当用户发送请求要查看哪个文件时，管理员查到这个文件在哪个字段服务器上，返回给客户，客户直接去找那个服务器，只有首要的字段服务器响应，一旦首要字段服务器死了，另外一个拥有副本的字段服务器才会响应请求。一旦“write”动作完成，首要字段服务器会更新所有其他字段服务器拥有的副本。

