# 11.分布式文件系统

|  | 延迟性 | 规模化能力 |
| :--- | :--- | :--- |
| 中心化文件系统（1个服务器） | good | poor |
| 分布式文件系统 | good? | good |

单一的服务器：单一服务器有很高的文件权限，因此没有延迟，非常高的工作压力，一旦这个服务器瘫痪，整个文件系统就瘫痪了

分布式系统两种模型：

* 远程进入模型：文件存储在远程服务器，客户端发送请求给远端服务器，服务器操作文件，完成后给客户端反馈，所有操作在远端完成。（容易实现）
* 上传下载模型：本地客户端发送“打开”请求给远端服务器，远端服务器复制文件下载到客户端，读写操作都在客户端完成，一旦完成再将文件上传给服务器。这种方法延迟性和服务器瘫痪都避免了，有限的复制也相当有利于规模化。分布式系统通常通过复制和局部化文件实现更好性能。（难实现一些）

NFS（networking file system）是最流行的分布式文件系统。

## NFS 客户端-服务器的架构

虚拟文件系统：本地和远端都有虚拟文件系统。如果要进入远端文件，就发送请求给NFS客户端，通过RPC客户端经纪人发送打开/读/写等请求给远端RPC服务器的经纪人，远端服务器经纪人与远端的虚拟文件系统联系。如此，RPC在客户端和服务器中间来回发送请求和反馈。

文件handle：相当于文件的身份证。

## NFS版本3和4的区别

NFS版本3:

* 要求新建才会新建文件
* 客户端和服务器迭代式交流
* 安装在你的个人主目录下

NFS版本4:

* 文件不存在自动新建
* 客户端和服务器循环式交流
* 自动安装在远端服务器上，然后发送反馈回来

名字解析和命名服务允许你进入本地和远端的文件而无需将文件都复制到本地的机器上。用符号链接大大提高了效率减少了延迟，例如/tmp/mount/alice直接指向/home/alice文件。

## 分布式系统文件分享的语义

中心化的模型：仅有一个处理器的情况。例如客户A想要写入一个文件ab加上c，客户B读取这个文件时立马能看到更醒后的文件abc。

分布式模型：如果客户A和B在不同的机器上，都要连接到远程服务器，这时客户A想要读写文件，服务器复制了一份文件给A，A在改写的同时，客户B也想读取文件，这时候服务器只能发送原始文件的复制件给B，虽然此时客户端已经知道这份文件已经被修改了但没有得到更新的文件。这对于客户B来说很不好，如何解决呢？

* 方案一：客户A在修改文件时，这份文件在服务端上锁，这样客户B就无法进入直到文件更新返回到服务器然后解锁才能读取文件。这种方案会有很好的性能，但是不适合规模化。
* 方案二：使某些功能弱化。例如客户A在修改文件，客户B这时只允许只读的方式打开文件，并且只能看到上一次完毕的修改而看不到A正在做的修改，直到客户A修改完成返回给客户端，客户端询问B是否想要看最新的文件，客户B可以自己决定看或者不看。
* Unix semantics VS Session semantics: 前者是，修改立即对其他用户可见，并且支持随时分享即便文件处于修改中；后者修改对其他用户不可见，除非修改完成并且文件关闭了，然后也有重新打开修改才可见。

**参考** [http://www.cs.jhu.edu/~yairamir/cs418/os7/tsld024.htm](http://www.cs.jhu.edu/~yairamir/cs418/os7/tsld024.htm)

